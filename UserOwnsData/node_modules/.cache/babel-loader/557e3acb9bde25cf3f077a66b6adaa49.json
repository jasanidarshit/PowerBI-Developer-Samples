{"ast":null,"code":"var _jsxFileName = \"/Users/darshitjasani/Documents/Code/GitHub/PowerBI-Developer-Samples/React-TS/Embed for your organization/UserOwnsData/src/App.tsx\";\n// ----------------------------------------------------------------------------\n// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n// ----------------------------------------------------------------------------\nimport { InteractionType, EventType } from \"@azure/msal-browser\";\nimport { MsalContext } from \"@azure/msal-react\";\nimport React from \"react\";\nimport { service, factories, models } from \"powerbi-client\";\nimport \"./App.css\";\nimport * as config from \"./Config\";\nconst powerbi = new service.Service(factories.hpmFactory, factories.wpmpFactory, factories.routerFactory);\nlet accessToken = \"\";\nlet embedUrl = \"\";\nlet reportContainer;\nlet reportRef;\nlet loading; // eslint-disable-next-line @typescript-eslint/no-empty-interface\n\n;\n;\n\nclass App extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      accessToken: \"\",\n      embedUrl: \"\",\n      error: []\n    };\n    reportRef = React.createRef(); // Report container\n\n    loading = /*#__PURE__*/React.createElement(\"div\", {\n      id: \"reportContainer\",\n      ref: reportRef,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 37,\n        columnNumber: 13\n      }\n    }, \"Loading the report...\");\n  } // React function\n\n\n  render() {\n    if (this.state.error.length) {\n      // Cleaning the report container contents and rendering the error message in multiple lines\n      reportContainer.textContent = \"\";\n      this.state.error.forEach(line => {\n        reportContainer.appendChild(document.createTextNode(line));\n        reportContainer.appendChild(document.createElement(\"br\"));\n      });\n    } else if (this.state.accessToken !== \"\" && this.state.embedUrl !== \"\") {\n      const embedConfiguration = {\n        type: \"report\",\n        tokenType: models.TokenType.Aad,\n        accessToken,\n        embedUrl,\n        id: config.reportId\n        /*\n        // Enable this setting to remove gray shoulders from embedded report\n        settings: {\n            background: models.BackgroundType.Transparent\n        }\n        */\n\n      };\n      const report = powerbi.embed(reportContainer, embedConfiguration); // Clear any other loaded handler events\n\n      report.off(\"loaded\"); // Triggers when a content schema is successfully loaded\n\n      report.on(\"loaded\", function () {\n        console.log(\"Report load successful\");\n      }); // Clear any other rendered handler events\n\n      report.off(\"rendered\"); // Triggers when a content is successfully embedded in UI\n\n      report.on(\"rendered\", function () {\n        console.log(\"Report render successful\");\n      }); // Clear any other error handler event\n\n      report.off(\"error\"); // Below patch of code is for handling errors that occur during embedding\n\n      report.on(\"error\", function (event) {\n        const errorMsg = event.detail; // Use errorMsg variable to log error in any destination of choice\n\n        console.error(errorMsg);\n      });\n    }\n\n    return loading;\n  } // React function\n\n\n  componentDidMount() {\n    if (reportRef !== null) {\n      reportContainer = reportRef[\"current\"];\n    } // User input - null check\n\n\n    if (config.workspaceId === \"\" || config.reportId === \"\") {\n      this.setState({\n        error: [\"Please assign values to workspace Id and report Id in Config.ts file\"]\n      });\n      return;\n    }\n\n    this.authenticate();\n  } // React function\n\n\n  componentDidUpdate() {\n    this.authenticate();\n  } // React function\n\n\n  componentWillUnmount() {\n    powerbi.reset(reportContainer);\n  } // Authenticating to get the access token\n\n\n  authenticate() {\n    const msalInstance = this.context.instance;\n    const msalAccounts = this.context.accounts;\n    const msalInProgress = this.context.inProgress;\n    const isAuthenticated = this.context.accounts.length > 0;\n\n    if (this.state.error.length > 0) {\n      return;\n    }\n\n    const eventCallback = msalInstance.addEventCallback(message => {\n      console.log(EventType);\n\n      if (message.eventType === EventType.LOGIN_SUCCESS && !accessToken) {\n        var _payload$account, _payload$account2;\n\n        const payload = message.payload;\n        const name = ((_payload$account = payload.account) === null || _payload$account === void 0 ? void 0 : _payload$account.name) ? (_payload$account2 = payload.account) === null || _payload$account2 === void 0 ? void 0 : _payload$account2.name : \"\";\n        accessToken = payload.accessToken;\n        this.setUsername(name);\n        this.tryRefreshUserPermissions();\n      }\n    });\n    const loginRequest = {\n      scopes: config.scopeBase,\n      account: msalAccounts[0]\n    };\n\n    if (!isAuthenticated && msalInProgress === InteractionType.None) {\n      msalInstance.loginRedirect(loginRequest);\n    } else if (isAuthenticated && accessToken && !embedUrl) {\n      this.getembedUrl();\n      msalInstance.removeEventCallback(eventCallback);\n    } else if (isAuthenticated && !accessToken && !embedUrl && msalInProgress === InteractionType.None) {\n      this.setUsername(msalAccounts[0].name); // get access token silently from cached id-token\n\n      msalInstance.acquireTokenSilent(loginRequest).then(response => {\n        accessToken = response.accessToken;\n        this.getembedUrl();\n      }).catch(error => {\n        // Refresh access token silently from cached id-token\n        // Makes the call to handleredirectcallback\n        if (error.errorCode === \"consent_required\" || error.errorCode === \"interaction_required\" || error.errorCode === \"login_required\") {\n          msalInstance.acquireTokenRedirect(loginRequest);\n        } else if (error.errorCode === '429') {\n          this.setState({\n            error: [\"Our Service Token Server (STS) is overloaded, please try again in sometime\"]\n          });\n        } else {\n          this.setState({\n            error: [\"There was some problem fetching the access token\" + error.toString()]\n          });\n        }\n      });\n    }\n  } // Power BI REST API call to refresh User Permissions in Power BI\n  // Refreshes user permissions and makes sure the user permissions are fully updated\n  // https://docs.microsoft.com/rest/api/power-bi/users/refreshuserpermissions\n\n\n  tryRefreshUserPermissions() {\n    fetch(config.powerBiApiUrl + \"v1.0/myorg/RefreshUserPermissions\", {\n      headers: {\n        \"Authorization\": \"Bearer \" + accessToken\n      },\n      method: \"POST\"\n    }).then(function (response) {\n      if (response.ok) {\n        console.log(\"User permissions refreshed successfully.\");\n      } else {\n        // Too many requests in one hour will cause the API to fail\n        if (response.status === 429) {\n          console.error(\"Permissions refresh will be available in up to an hour.\");\n        } else {\n          console.error(response);\n        }\n      }\n    }).catch(function (error) {\n      console.error(\"Failure in making API call.\" + error);\n    });\n  } // Power BI REST API call to get the embed URL of the report\n\n\n  getembedUrl() {\n    const thisObj = this;\n    fetch(config.powerBiApiUrl + \"v1.0/myorg/groups/\" + config.workspaceId + \"/reports/\" + config.reportId, {\n      headers: {\n        \"Authorization\": \"Bearer \" + accessToken\n      },\n      method: \"GET\"\n    }).then(function (response) {\n      const errorMessage = [];\n      errorMessage.push(\"Error occurred while fetching the embed URL of the report\");\n      errorMessage.push(\"Request Id: \" + response.headers.get(\"requestId\"));\n      response.json().then(function (body) {\n        // Successful response\n        if (response.ok) {\n          embedUrl = body[\"embedUrl\"];\n          thisObj.setState({\n            accessToken: accessToken,\n            embedUrl: embedUrl\n          });\n        } // If error message is available\n        else {\n            errorMessage.push(\"Error \" + response.status + \": \" + body.error.code);\n            thisObj.setState({\n              error: errorMessage\n            });\n          }\n      }).catch(function () {\n        errorMessage.push(\"Error \" + response.status + \":  An error has occurred\");\n        thisObj.setState({\n          error: errorMessage\n        });\n      });\n    }).catch(function (error) {\n      // Error in making the API call\n      thisObj.setState({\n        error: error\n      });\n    });\n  } // Show username in the UI\n\n\n  setUsername(username) {\n    const welcome = document.getElementById(\"welcome\"); // if (welcome !== null)\n    //     welcome.innerText = \"Welcome, \" + username;\n  }\n\n}\n\nApp.contextType = MsalContext;\nexport default App;","map":{"version":3,"sources":["/Users/darshitjasani/Documents/Code/GitHub/PowerBI-Developer-Samples/React-TS/Embed for your organization/UserOwnsData/src/App.tsx"],"names":["InteractionType","EventType","MsalContext","React","service","factories","models","config","powerbi","Service","hpmFactory","wpmpFactory","routerFactory","accessToken","embedUrl","reportContainer","reportRef","loading","App","Component","constructor","props","state","error","createRef","render","length","textContent","forEach","line","appendChild","document","createTextNode","createElement","embedConfiguration","type","tokenType","TokenType","Aad","id","reportId","report","embed","off","on","console","log","event","errorMsg","detail","componentDidMount","workspaceId","setState","authenticate","componentDidUpdate","componentWillUnmount","reset","msalInstance","context","instance","msalAccounts","accounts","msalInProgress","inProgress","isAuthenticated","eventCallback","addEventCallback","message","eventType","LOGIN_SUCCESS","payload","name","account","setUsername","tryRefreshUserPermissions","loginRequest","scopes","scopeBase","None","loginRedirect","getembedUrl","removeEventCallback","acquireTokenSilent","then","response","catch","errorCode","acquireTokenRedirect","toString","fetch","powerBiApiUrl","headers","method","ok","status","thisObj","errorMessage","push","get","json","body","code","username","welcome","getElementById","contextType"],"mappings":"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","sourcesContent":["// ----------------------------------------------------------------------------\n// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n// ----------------------------------------------------------------------------\n\nimport { AuthenticationResult, InteractionType, EventMessage, EventType, AuthError } from \"@azure/msal-browser\";\nimport { MsalContext } from \"@azure/msal-react\";\nimport React from \"react\";\nimport { service, factories, models, IEmbedConfiguration } from \"powerbi-client\";\nimport \"./App.css\";\nimport * as config from \"./Config\";\n\nconst powerbi = new service.Service(factories.hpmFactory, factories.wpmpFactory, factories.routerFactory);\n\nlet accessToken = \"\";\nlet embedUrl = \"\";\nlet reportContainer: HTMLElement;\nlet reportRef: React.Ref<HTMLDivElement>;\nlet loading: JSX.Element;\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\ninterface AppProps { };\ninterface AppState { accessToken: string; embedUrl: string; error: string[] };\n\nclass App extends React.Component<AppProps, AppState> {\n    static contextType = MsalContext;\n\n    constructor(props: AppProps) {\n        super(props);\n\n        this.state = { accessToken: \"\", embedUrl: \"\", error: [] };\n\n        reportRef = React.createRef();\n\n        // Report container\n        loading = (\n            <div\n                id=\"reportContainer\"\n                ref={reportRef} >\n                Loading the report...\n            </div>\n        );\n    }\n\n    // React function\n    render(): JSX.Element {\n\n        if (this.state.error.length) {\n\n            // Cleaning the report container contents and rendering the error message in multiple lines\n            reportContainer.textContent = \"\";\n            this.state.error.forEach(line => {\n                reportContainer.appendChild(document.createTextNode(line));\n                reportContainer.appendChild(document.createElement(\"br\"));\n            });\n        }\n        else if (this.state.accessToken !== \"\" && this.state.embedUrl !== \"\") {\n\n            const embedConfiguration: IEmbedConfiguration = {\n                type: \"report\",\n                tokenType: models.TokenType.Aad,\n                accessToken,\n                embedUrl,\n                id: config.reportId,\n                /*\n                // Enable this setting to remove gray shoulders from embedded report\n                settings: {\n                    background: models.BackgroundType.Transparent\n                }\n                */\n            };\n\n            const report = powerbi.embed(reportContainer, embedConfiguration);\n\n            // Clear any other loaded handler events\n            report.off(\"loaded\");\n\n            // Triggers when a content schema is successfully loaded\n            report.on(\"loaded\", function () {\n                console.log(\"Report load successful\");\n            });\n\n            // Clear any other rendered handler events\n            report.off(\"rendered\");\n\n            // Triggers when a content is successfully embedded in UI\n            report.on(\"rendered\", function () {\n                console.log(\"Report render successful\");\n            });\n\n            // Clear any other error handler event\n            report.off(\"error\");\n\n            // Below patch of code is for handling errors that occur during embedding\n            report.on(\"error\", function (event) {\n                const errorMsg = event.detail;\n\n                // Use errorMsg variable to log error in any destination of choice\n                console.error(errorMsg);\n            });\n        }\n\n        return loading;\n    }\n\n    // React function\n    componentDidMount(): void {\n        if (reportRef !== null) {\n            reportContainer = reportRef[\"current\"];\n        }\n\n        // User input - null check\n        if (config.workspaceId === \"\" || config.reportId === \"\") {\n            this.setState({ error: [\"Please assign values to workspace Id and report Id in Config.ts file\"] });\n            return;\n        }\n\n        this.authenticate();\n    }\n\n    // React function\n    componentDidUpdate(): void {\n        this.authenticate();\n    }\n\n    // React function\n    componentWillUnmount(): void {\n        powerbi.reset(reportContainer);\n    }\n\n    // Authenticating to get the access token\n    authenticate(): void {\n        const msalInstance = this.context.instance;\n        const msalAccounts = this.context.accounts;\n        const msalInProgress = this.context.inProgress;\n        const isAuthenticated = this.context.accounts.length > 0;\n\n        if (this.state.error.length > 0) {\n            return;\n        }\n\n        const eventCallback = msalInstance.addEventCallback((message: EventMessage) => {\n            console.log(EventType)\n            if (message.eventType === EventType.LOGIN_SUCCESS && !accessToken) {\n                const payload = message.payload as AuthenticationResult;\n                const name: string = payload.account?.name ? payload.account?.name: \"\";\n\n                accessToken = payload.accessToken;\n                this.setUsername(name);\n                this.tryRefreshUserPermissions();\n            }\n        });\n\n        const loginRequest = {\n            scopes: config.scopeBase,\n            account: msalAccounts[0]\n        };\n\n        if (!isAuthenticated && msalInProgress === InteractionType.None) {\n            msalInstance.loginRedirect(loginRequest);\n        }\n        else if (isAuthenticated && accessToken && !embedUrl) {\n            this.getembedUrl();\n            msalInstance.removeEventCallback(eventCallback);\n        }\n        else if (isAuthenticated && !accessToken && !embedUrl && msalInProgress === InteractionType.None) {\n            this.setUsername(msalAccounts[0].name);\n\n            // get access token silently from cached id-token\n            msalInstance.acquireTokenSilent(loginRequest).then((response: AuthenticationResult) => {\n                accessToken = response.accessToken;\n                this.getembedUrl();\n            }).catch((error: AuthError) => {\n                // Refresh access token silently from cached id-token\n                // Makes the call to handleredirectcallback\n                if (error.errorCode === \"consent_required\" || error.errorCode === \"interaction_required\" || error.errorCode === \"login_required\") {\n                    msalInstance.acquireTokenRedirect(loginRequest);\n                }\n                else if (error.errorCode === '429') {\n                    this.setState({ error: [\"Our Service Token Server (STS) is overloaded, please try again in sometime\"] });\n                }\n                else {\n                    this.setState({ error: [\"There was some problem fetching the access token\" + error.toString()] });\n                }\n            });\n        }\n    }\n\n    // Power BI REST API call to refresh User Permissions in Power BI\n    // Refreshes user permissions and makes sure the user permissions are fully updated\n    // https://docs.microsoft.com/rest/api/power-bi/users/refreshuserpermissions\n    tryRefreshUserPermissions(): void {\n        fetch(config.powerBiApiUrl + \"v1.0/myorg/RefreshUserPermissions\", {\n            headers: {\n                \"Authorization\": \"Bearer \" + accessToken\n            },\n            method: \"POST\"\n        })\n        .then(function (response) {\n            if (response.ok) {\n                console.log(\"User permissions refreshed successfully.\");\n            } else {\n                // Too many requests in one hour will cause the API to fail\n                if (response.status === 429) {\n                    console.error(\"Permissions refresh will be available in up to an hour.\");\n                } else {\n                    console.error(response);\n                }\n            }\n        })\n        .catch(function (error) {\n            console.error(\"Failure in making API call.\" + error);\n        });\n    }\n\n    // Power BI REST API call to get the embed URL of the report\n    getembedUrl(): void {\n        const thisObj: this = this;\n\n        fetch(config.powerBiApiUrl + \"v1.0/myorg/groups/\" + config.workspaceId + \"/reports/\" + config.reportId, {\n            headers: {\n                \"Authorization\": \"Bearer \" + accessToken\n            },\n            method: \"GET\"\n        })\n            .then(function (response) {\n                const errorMessage: string[] = [];\n                errorMessage.push(\"Error occurred while fetching the embed URL of the report\")\n                errorMessage.push(\"Request Id: \" + response.headers.get(\"requestId\"));\n\n                response.json()\n                    .then(function (body) {\n                        // Successful response\n                        if (response.ok) {\n                            embedUrl = body[\"embedUrl\"];\n                            thisObj.setState({ accessToken: accessToken, embedUrl: embedUrl });\n                        }\n                        // If error message is available\n                        else {\n                            errorMessage.push(\"Error \" + response.status + \": \" + body.error.code);\n\n                            thisObj.setState({ error: errorMessage });\n                        }\n\n                    })\n                    .catch(function () {\n                        errorMessage.push(\"Error \" + response.status + \":  An error has occurred\");\n\n                        thisObj.setState({ error: errorMessage });\n                    });\n            })\n            .catch(function (error) {\n\n                // Error in making the API call\n                thisObj.setState({ error: error });\n            })\n    }\n\n    // Show username in the UI\n    setUsername(username: string): void {\n        const welcome = document.getElementById(\"welcome\");\n        // if (welcome !== null)\n        //     welcome.innerText = \"Welcome, \" + username;\n    }\n}\n\nexport default App;"]},"metadata":{},"sourceType":"module"}